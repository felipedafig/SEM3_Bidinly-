@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Shared.DTOs.Notifications
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation
@inject HttpClient Http
@implements IDisposable

<header class="navbar-header">
    <div class="navbar-container">
        <div class="navbar-brand">
            <img src="/assets/icons/Bidinly-Logo.png" alt="Bidinly" class="logo" />
            <span class="brand-text">Bidinly</span>
        </div>
        <nav class="navbar-nav">
            <AuthorizeView>
                <Authorized Context="authContext">
                    @{
                        var roleName = authContext.User.FindFirst("RoleName")?.Value;

                        var isBuyer = string.Equals(roleName, "Buyer", StringComparison.OrdinalIgnoreCase);
                        var isAgent = string.Equals(roleName, "Agent", StringComparison.OrdinalIgnoreCase);
                        var isAdmin = string.Equals(roleName, "Admin", StringComparison.OrdinalIgnoreCase);

                        var dashboardRoute =
                            isBuyer ? "buyer-dashboard" :
                            isAgent ? "agent-dashboard" :
                            isAdmin ? "admin-dashboard" :
                            "buyer-dashboard";

                        var salesRoute =
                            isAgent ? "agent/sales" :
                            isBuyer ? "buyer/sales" :
                            "sales";
                    }
                    @if (isAdmin)
                    {
                        <button class="nav-link nav-button"
                                @onclick='() => Navigation.NavigateTo($"/{dashboardRoute}", true)'>
                            Home
                        </button>
                        <NavLink class="nav-link" href="requests">Requests</NavLink>
                        <NavLink class="nav-link" href="users">Users</NavLink>
                    }
                    else
                    {
                        <button class="nav-link nav-button"
                                @onclick='() => Navigation.NavigateTo($"/{dashboardRoute}", true)'>
                            Home
                        </button>
                        @if (isAgent)
                        {
                            <NavLink class="nav-link" href="my-properties">Properties</NavLink>
                        }
                        else
                        {
                            <NavLink class="nav-link" href="bids">Bids</NavLink>
                        }
                        <NavLink class="nav-link" href="@salesRoute">Sales</NavLink>
                    }
                    <div class="user-dropdown @(isDropdownOpen ? "show" : "")">
                        <button class="user-dropdown-toggle nav-link nav-button" @onclick="ToggleDropdown" @onclick:stopPropagation="true">
                            Hi @authContext.User.Identity?.Name
                            <span class="dropdown-arrow">▼</span>
                        </button>
                        @if (isDropdownOpen)
                        {
                            <div class="dropdown-backdrop" @onclick="CloseDropdown"></div>
                        }
                        <div class="user-dropdown-menu @(isDropdownOpen ? "show" : "")" @onclick:stopPropagation="true">
                            <div class="dropdown-header">@authContext.User.Identity?.Name</div>
                            @if (isBuyer)
                            {
                                <button class="dropdown-item" @onclick='() => Navigation.NavigateTo("/buyer-notifications")'>
                                    Notifications (@NotificationCount)
                                </button>
                            }
                            else if (isAgent)
                            {
                                <button class="dropdown-item" @onclick='() => Navigation.NavigateTo("/agent-notifications")'>
                                    Notifications (@NotificationCount)
                                </button>
                            }
                            <button class="dropdown-item" @onclick="HandleLogout">Logout</button>
                        </div>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="nav-link" href="" Match="NavLinkMatch.All">Home</NavLink>
                    <NavLink class="nav-link" href="login">Login</NavLink>
                    <NavLink class="nav-link" href="signup">Sign Up</NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </nav>
    </div>
</header>

@code {
    private bool isDropdownOpen = false;
    private int NotificationCount = 0;

    protected override async void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        await LoadNotificationCountAsync();
    }

    private async void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
        if (isDropdownOpen)
        {
            await LoadNotificationCountAsync();
        }
        StateHasChanged();
    }

    private void CloseDropdown()
    {
        isDropdownOpen = false;
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        isDropdownOpen = false;
        var authProvider = (AuthProvider)AuthProvider;
        await authProvider.Logout();
        Navigation.NavigateTo("/", forceLoad: false);
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        isDropdownOpen = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
    
    private int? GetUserId(ClaimsPrincipal user)
    {
        var idClaim = user.FindFirst("Id")?.Value;
        return int.TryParse(idClaim, out var id) ? id : null;
    }
    
    private async Task LoadNotificationCountAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            NotificationCount = 0;
            return;
        }

        var userId = GetUserId(user);
        if (userId == null)
        {
            NotificationCount = 0;
            return;
        }

        var roleName = user.FindFirst("RoleName")?.Value;

        string url;

        if (string.Equals(roleName, "Buyer", StringComparison.OrdinalIgnoreCase))
        {
            url = $"/notifications?recipientType=Buyer&buyerId={userId}&isRead=false";
        }
        else if (string.Equals(roleName, "Agent", StringComparison.OrdinalIgnoreCase))
        {
            url = $"/notifications?recipientType=Agent&agentId={userId}&isRead=false";
        }
        else
        {
            NotificationCount = 0;
            return;
        }

        var notifications = await Http.GetFromJsonAsync<List<NotificationDto>>(url);
        NotificationCount = notifications?.Count ?? 0;

        StateHasChanged();
    }
}

