@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation
@implements IDisposable

<header class="navbar-header">
    <div class="navbar-container">
        <div class="navbar-brand">
            <img src="/assets/icons/Bidinly-Logo.png" alt="Bidinly" class="logo" />
            <span class="brand-text">Bidinly</span>
        </div>
        <nav class="navbar-nav">
            <AuthorizeView>
                <Authorized Context="authContext">
                    @{
                        var roleName = authContext.User.FindFirst("RoleName")?.Value;
                        var dashboardRoute = string.Equals(roleName, "Buyer", StringComparison.OrdinalIgnoreCase) 
                            ? "buyer-dashboard" 
                            : string.Equals(roleName, "Agent", StringComparison.OrdinalIgnoreCase) 
                                ? "agent-dashboard" 
                                : string.Equals(roleName, "Admin", StringComparison.OrdinalIgnoreCase)
                                    ? "admin-dashboard"
                                    : "buyer-dashboard";
                        var isAgent = string.Equals(roleName, "Agent", StringComparison.OrdinalIgnoreCase);
                        var isAdmin = string.Equals(roleName, "Admin", StringComparison.OrdinalIgnoreCase);
                        var isBuyer = string.Equals(roleName, "Buyer", StringComparison.OrdinalIgnoreCase);
                        
                        var salesRoute = isAgent ? "agent/sales"
                            : isBuyer ? "buyer/sales"
                            : "sales";
                    }
                    @if (isAdmin)
                    {
                        <button class="nav-link nav-button"
                                @onclick='() => Navigation.NavigateTo($"/{dashboardRoute}", true)'>
                            Home
                        </button>
                        <NavLink class="nav-link" href="requests">Requests</NavLink>
                        <NavLink class="nav-link" href="users">Users</NavLink>
                    }
                    else
                    {
                        <button class="nav-link nav-button"
                                @onclick='() => Navigation.NavigateTo($"/{dashboardRoute}", true)'>
                            Home
                        </button>
                        @if (isAgent)
                        {
                            <NavLink class="nav-link" href="my-properties">Properties</NavLink>
                        }
                        else
                        {
                            <NavLink class="nav-link" href="bids">Bids</NavLink>
                        }
                        <NavLink class="nav-link" href="@salesRoute">Sales</NavLink>
                    }
                    <div class="user-dropdown @(isDropdownOpen ? "show" : "")">
                        <button class="user-dropdown-toggle nav-link nav-button" @onclick="ToggleDropdown" @onclick:stopPropagation="true">
                            Hi @authContext.User.Identity?.Name
                            <span class="dropdown-arrow">▼</span>
                        </button>
                        @if (isDropdownOpen)
                        {
                            <div class="dropdown-backdrop" @onclick="CloseDropdown"></div>
                        }
                        <div class="user-dropdown-menu @(isDropdownOpen ? "show" : "")" @onclick:stopPropagation="true">
                            <div class="dropdown-header">@authContext.User.Identity?.Name</div>
                            @if (isBuyer)
                            {
                                <button class="dropdown-item" @onclick='() => Navigation.NavigateTo("/buyer-notifications")'>
                                    Notifications (@NotificationCount)
                                </button>
                            }
                            else if (isAgent)
                            {
                                <button class="dropdown-item" @onclick='() => Navigation.NavigateTo("/agent-notifications")'>
                                    Notifications (@NotificationCount)
                                </button>
                            }
                            <button class="dropdown-item" @onclick="HandleLogout">Logout</button>
                        </div>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="nav-link" href="" Match="NavLinkMatch.All">Home</NavLink>
                    <NavLink class="nav-link" href="login">Login</NavLink>
                    <NavLink class="nav-link" href="signup">Sign Up</NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </nav>
    </div>
</header>

@code {
    private bool isDropdownOpen = false;
    private int NotificationCount = 0;

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
        StateHasChanged();
    }

    private void CloseDropdown()
    {
        isDropdownOpen = false;
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        isDropdownOpen = false;
        var authProvider = (AuthProvider)AuthProvider;
        await authProvider.Logout();
        Navigation.NavigateTo("/", forceLoad: false);
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        isDropdownOpen = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}

