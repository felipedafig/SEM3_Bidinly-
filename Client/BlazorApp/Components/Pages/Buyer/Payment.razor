@page "/payment/{PropertyId:int}"
@layout NoLayout
@inject NavigationManager Navigation
@inject HttpClient Http
@using Shared.DTOs.Payments

<PageTitle>Payment - Bidinly</PageTitle>

<div class="payment-page">
    <div class="page-header">
        <button class="back-button" @onclick="GoBack">← Back</button>
        <h1 class="page-title">Complete Your Payment</h1>
    </div>

    <div class="payment-container">

        <!-- Property Summary -->
        <div class="payment-card">
            <h2 class="section-title">Property Summary</h2>

            <div class="summary-item">
                <strong>Property:</strong> @PropertyTitle
            </div>
            <div class="summary-item">
                <strong>Amount Due:</strong> @Price.ToString("N0") Kr
            </div>
        </div>

        <!-- Payment Form -->
        <div class="payment-card">
            <h2 class="section-title">Payment Details</h2>

            <div class="form-group">
                <label>Name on Card</label>
                <input class="input" @bind="NameOnCard" placeholder="Full Name" />
            </div>

            <div class="form-group">
                <label>Card Number</label>
                <input class="input" @bind="CardNumber" maxlength="19" placeholder="xxxx xxxx xxxx xxxx" />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Expiration (MM/YY)</label>
                    <input class="input" @bind="Expiration" maxlength="5" placeholder="MM/YY" />
                </div>

                <div class="form-group">
                    <label>CVC</label>
                    <input class="input" @bind="CVC" maxlength="4" placeholder="123" />
                </div>
            </div>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="error-message">@ErrorMessage</div>
            }

            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="success-message">@SuccessMessage</div>
            }

            <button class="pay-button" @onclick="SubmitPayment" disabled="@IsSubmitting">
                @if (IsSubmitting)
                {
                    <text>Processing...</text>
                }
                else
                {
                    <text>Pay Now</text>
                }
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public int PropertyId { get; set; }

    private string PropertyTitle = "";
    private decimal Price = 0;

    // Form fields
    private string NameOnCard = "";
    private string CardNumber = "";
    private string Expiration = "";
    private string CVC = "";
    private string Email = "";
    private string Address = "";

    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private bool IsSubmitting = false;

    protected override void OnInitialized()
    {
        // replace with api
        PropertyTitle = "Modern Apartment in Oslo";
        Price = 4_500_000;
    }

    private void GoBack() =>
        Navigation.NavigateTo($"/buyer-notifications");
    
    private async Task SubmitPayment()
    {
        ErrorMessage = "";
        SuccessMessage = "";

        if (string.IsNullOrWhiteSpace(NameOnCard) ||
            string.IsNullOrWhiteSpace(CardNumber) ||
            string.IsNullOrWhiteSpace(Expiration) ||
            string.IsNullOrWhiteSpace(CVC))
        {
            ErrorMessage = "Please fill all required fields.";
            return;
        }

        IsSubmitting = true;

        try
        {
            var dto = new ValidateCardDto
            {
                CardNumber = CardNumber.Replace(" ", ""),
                ExpirationDate = Expiration,
                Cvc = CVC,
                Name = NameOnCard,
                PropertyId = PropertyId,

                // ⚠️ TEMP (next step we load these properly)
                BidId = 29,
                BuyerId = 3,
                AgentId = 2
            };

            var response = await Http.PostAsJsonAsync(
                "payments/validate-card",
                dto
            );

            if (!response.IsSuccessStatusCode)
            {
                ErrorMessage = "Payment service error.";
                return;
            }

            var result = await response.Content
                .ReadFromJsonAsync<ValidateCardResponseDto>();

            if (result == null)
            {
                ErrorMessage = "Invalid response from payment service.";
                return;
            }

            if (!result.IsValid)
            {
                ErrorMessage = result.Message;
                return;
            }

            SuccessMessage = "Payment completed successfully!";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Payment failed: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}