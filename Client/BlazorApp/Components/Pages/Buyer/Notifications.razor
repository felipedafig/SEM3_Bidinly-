@page "/buyer-notifications"
@layout NoLayout
@inject NavigationManager Navigation
@using Shared.DTOs.Notifications
@inject HttpClient Http
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Notifications - Bidinly</PageTitle>

<div class="notifications-page">

    <button class="back-button" @onclick="GoBack">
        ‚Üê Back
    </button>

    <div class="page-header">
        <h1 class="page-title">Notifications</h1>
    </div>

    <div class="notifications-section">

        @if (isLoading)
        {
            <div class="loading">Loading notifications...</div>
        }
        else if (notifications == null || !notifications.Any())
        {
            <div class="no-results">No notifications yet.</div>
        }
        else
        {
            <div class="notifications-container">
                @foreach (var n in notifications)
                {
                    var title = n.Status == "Accepted" ? "Bid Accepted" : "Bid Rejected";
                    var type = n.Status == "Accepted" ? "success" : "error";

                    <div class="notification-card @GetTypeClass(type)">
                        <div class="notification-header">
                            <h3 class="notification-title">@title</h3>
                            <span class="notification-date">
                                @n.CreatedAt.ToString("g")
                            </span>
                        </div>

                        <div class="notification-message">@n.Message</div>

                        @if (n.Status == "Accepted")
                        {
                            <button class="notif-action-button"
                                    @onclick="() => GoToPayment(n.PropertyId)">
                                Go to Payment
                            </button>
                        }
                        else
                        {
                            <button class="notif-action-button"
                                    @onclick="() => ViewProperty(n.PropertyId)">
                                View Property
                            </button>
                        }
                    </div>
                }
            </div>
        }

    </div>
</div>

@code {
    private List<NotificationDto> notifications = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var buyerIdClaim = user.FindFirst("Id")?.Value;
        if (buyerIdClaim == null)
            return;

        var buyerId = int.Parse(buyerIdClaim);

        notifications = await Http.GetFromJsonAsync<List<NotificationDto>>(
            $"/notifications?recipientType=Buyer&buyerId={buyerId}"
        ) ?? new();

        isLoading = false;
    }

    private void GoBack() =>
        Navigation.NavigateTo("/buyer-dashboard");

    private void GoToPayment(int propertyId) =>
        Navigation.NavigateTo($"/payment/{propertyId}");

    private void ViewProperty(int propertyId) =>
        Navigation.NavigateTo($"/property/{propertyId}");

    private string GetTypeClass(string type) =>
        type switch
        {
            "success" => "notif-success",
            "error" => "notif-error",
            _ => "notif-info"
        };
}