@page "/login"
@namespace BlazorApp.Components.Pages
@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Security.Claims
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

<PageTitle>Login - Bidinly</PageTitle>

<div class="login-page">
    <div class="login-container">
        <div class="login-header">
            <h1>Login</h1>
            <p>Enter your credentials to access your account</p>
        </div>
        
        <div class="login-form-container">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="login-error-message">
                    @errorMessage
                </div>
            }
            
            <div class="login-form-group">
                <label for="login-username">Username</label>
                <input type="text" 
                       id="login-username" 
                       class="login-form-input" 
                       @bind="username" 
                       @bind:event="oninput"
                       placeholder="Enter your username"
                       @onkeydown="HandleKeyDown" />
            </div>
            
            <div class="login-form-group">
                <label for="login-password">Password</label>
                <input type="password" 
                       id="login-password" 
                       class="login-form-input" 
                       @bind="password" 
                       @bind:event="oninput"
                       placeholder="Enter your password"
                       @onkeydown="HandleKeyDown" />
            </div>
            
            <div class="login-form-actions">
                <button class="login-button-cancel" @onclick="HandleCancel">Cancel</button>
                <button class="login-button-confirm" @onclick="async () => await HandleLogin()" disabled="@(isLoading || string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))">
                    @if (isLoading)
                    {
                        <span>Logging in...</span>
                    }
                    else
                    {
                        <span>Login</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private string username = string.Empty;
    private string password = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password) || isLoading)
        {
            return;
        }

        try
        {
            isLoading = true;
            errorMessage = string.Empty;

            if (AuthProvider is AuthProvider authProvider)
            {
                await authProvider.Login(username, password);
                
                var authState = await AuthProvider.GetAuthenticationStateAsync();
                var roleName = authState.User.FindFirst("RoleName")?.Value;
                
                if (string.Equals(roleName, "Buyer", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/buyer-dashboard");
                }
                else if (string.Equals(roleName, "Agent", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/agent-dashboard");
                }
                else if (string.Equals(roleName, "Admin", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/admin-dashboard");
                }
                else
                {
                    Navigation.NavigateTo("/buyer-dashboard");
                }
            }
            else
            {
                errorMessage = "Authentication provider not available";
                return;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/", forceLoad: false);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await HandleLogin();
        }
    }
}

