@page "/agent-dashboard"

@namespace BlazorApp.Components.Pages

@using Microsoft.AspNetCore.Components

@using Microsoft.AspNetCore.Components.Web

@using Microsoft.AspNetCore.Components.Authorization

@attribute [Authorize]

@inject NavigationManager Navigation

@inject AuthenticationStateProvider AuthProvider

<PageTitle>Agent Dashboard - Bidinly</PageTitle>

<div class="home-background">

    <img src="/assets/images/Home-Background.png" alt="Modern Property" />

    

    <div class="welcome-section">

        @if (isLoadingAuth)

        {

            <div class="welcome-container">

                <img src="/assets/icons/agentIcon.png" alt="Agent Icon" class="welcome-icon" />

                <h2 class="welcome-text">Welcome Agent!</h2>

            </div>

        }

        else

        {

            <div class="welcome-container">

                <img src="@welcomeIconPath" alt="@welcomeIconAlt" class="welcome-icon" />

                <h2 class="welcome-text">Welcome @welcomeRoleName!</h2>

            </div>

        }

    </div>

    

    <div class="hero-content">

        <AuthorizeView>

            <Authorizing>

                <h1 class="hero-title">Auction your properties to maximize profits...</h1>

            </Authorizing>

            <Authorized Context="authContext">

                @{

                    var role = authContext.User.FindFirst("RoleName")?.Value ?? "Agent";

                    var heroTitle = role switch

                    {

                        "Admin" => "Manage property creation.",

                        "Agent" => "Auction your properties to maximize profits...",

                        _ => "Bid to win your Dream Property..."

                    };

                }

                <h1 class="hero-title">@heroTitle</h1>

            </Authorized>

            <NotAuthorized>

                <h1 class="hero-title">Auction your properties to maximize profits...</h1>

            </NotAuthorized>

        </AuthorizeView>

        <div class="hero-search-container">

            <input type="text" class="hero-search-bar" placeholder="Find a property..." @bind="searchQuery" @onkeydown="HandleSearchKeyDown" />

            <button class="hero-search-button" @onclick="PerformSearch" type="button">

                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">

                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>

                </svg>

            </button>

        </div>

    </div>

</div>

<div class="filter-search-section">

    <div class="filter-search-container">

        <div class="filter-field">

            <label class="filter-label">City</label>

            <input type="text" class="filter-input" placeholder="city?" @bind="filterCity" />

        </div>

        <div class="filter-separator"></div>

        <div class="filter-field">

            <label class="filter-label">Bedrooms</label>

            <input type="number" class="filter-input" placeholder="bedrooms?" min="0" @bind="filterBedrooms" />

        </div>

        <div class="filter-separator"></div>

        <div class="filter-field">

            <label class="filter-label">Bathrooms</label>

            <input type="number" class="filter-input" placeholder="bathrooms?" min="0" @bind="filterBathrooms" />

        </div>

        <div class="filter-separator"></div>

        <div class="filter-field">

            <label class="filter-label">Min Price</label>

            <input type="number" class="filter-input" placeholder="min price?" min="0" @bind="filterMinPrice" />

        </div>

        <div class="filter-separator"></div>

        <div class="filter-field">

            <label class="filter-label">Max Price</label>

            <input type="number" class="filter-input" placeholder="max price?" min="0" @bind="filterMaxPrice" />

        </div>

        <button class="filter-search-button" @onclick="PerformFilterSearch" type="button">

            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">

                <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>

            </svg>

        </button>

    </div>

</div>


@code {

    private bool isLoadingAuth = true;

    private string searchQuery = string.Empty;

    private string filterCity = string.Empty;

    private int? filterBedrooms;

    private int? filterBathrooms;

    private double? filterMinPrice;

    private double? filterMaxPrice;

    private string welcomeRoleName = "Agent";

    private string welcomeIconPath = "/assets/icons/agentIcon.png";

    private string welcomeIconAlt = "Agent Icon";

    protected override async Task OnInitializedAsync()

    {

        await LoadAuthState();

    }

    private async Task LoadAuthState()

    {

        isLoadingAuth = true;

        try

        {

            var authState = await AuthProvider.GetAuthenticationStateAsync();

            if (authState.User.Identity?.IsAuthenticated == true)

            {

                welcomeRoleName = authState.User.FindFirst("RoleName")?.Value ?? "Agent";

                welcomeIconPath = welcomeRoleName switch

                {

                    "Admin" => "/assets/icons/adminIcon.png",

                    "Agent" => "/assets/icons/agentIcon.png",

                    _ => "/assets/icons/buyerIcon.png"

                };

                welcomeIconAlt = $"{welcomeRoleName} Icon";

            }

            else

            {

                welcomeRoleName = "Agent";

                welcomeIconPath = "/assets/icons/agentIcon.png";

                welcomeIconAlt = "Agent Icon";

            }

        }

        catch

        {

            welcomeRoleName = "Agent";

            welcomeIconPath = "/assets/icons/agentIcon.png";

            welcomeIconAlt = "Agent Icon";

        }

        finally

        {

            isLoadingAuth = false;

        }

    }

    private async Task PerformSearch()

    {

        if (!string.IsNullOrWhiteSpace(searchQuery))

        {

            Navigation.NavigateTo($"/?search={Uri.EscapeDataString(searchQuery)}");

        }

    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)

    {

        if (e.Key == "Enter")

        {

            await PerformSearch();

        }

    }

    private async Task PerformFilterSearch()

    {

        var queryParams = new List<string>();

        if (!string.IsNullOrWhiteSpace(filterCity))

        {

            queryParams.Add($"city={Uri.EscapeDataString(filterCity)}");

        }

        if (filterBedrooms.HasValue)

        {

            queryParams.Add($"bedrooms={filterBedrooms.Value}");

        }

        if (filterBathrooms.HasValue)

        {

            queryParams.Add($"bathrooms={filterBathrooms.Value}");

        }

        if (filterMinPrice.HasValue)

        {

            queryParams.Add($"minPrice={filterMinPrice.Value}");

        }

        if (filterMaxPrice.HasValue)

        {

            queryParams.Add($"maxPrice={filterMaxPrice.Value}");

        }

        var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";

        Navigation.NavigateTo($"/{queryString}");

    }

}
