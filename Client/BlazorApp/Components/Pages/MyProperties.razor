@page "/my-properties"

@namespace BlazorApp.Components.Pages

@using shared.DTOs.Properties

@using Microsoft.AspNetCore.Components

@using Microsoft.AspNetCore.Components.Web

@using Microsoft.AspNetCore.Components.Authorization

@using Microsoft.AspNetCore.Components.Forms

@attribute [Authorize]

@inject HttpPropertyService PropertyService

@inject NavigationManager Navigation

@inject AuthenticationStateProvider AuthProvider

<PageTitle>My Properties - Bidinly</PageTitle>

<div class="my-properties-page">

    <div class="page-header">

        <h1 class="page-title">My Properties</h1>

        <button class="add-property-button" @onclick="ShowCreatePropertyModal" type="button">

            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">

                <path d="M12 5V19M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>

            </svg>

            Add Property

        </button>

    </div>

    <div class="properties-section">

        <div class="properties-container">

            @if (isLoading)

            {

                <div class="loading">Loading properties...</div>

            }

            else if (properties == null || !properties.Any())

            {

                <div class="no-results">No properties found. Click "Add Property" to create your first property.</div>

            }

            else

            {

                @foreach (var property in properties)

                {

                    <div class="property-card" @onclick="() => NavigateToProperty(property.Id)">

                        <div class="card-image-placeholder">

                            <span>Image</span>

                        </div>

                        <div class="card-details">

                            <h3 class="card-title">@property.Title</h3>

                            <p class="card-address">@property.Address</p>

                            <p class="card-description">@property.Description</p>

                            <div class="card-info">

                                <span class="info-item">Bedrooms: @property.Bedrooms</span>

                                <span class="info-item">Bathrooms: @property.Bathrooms</span>

                                <span class="info-item">Size: @property.SizeInSquareFeet sq ft</span>

                                <span class="info-item">Price: $@property.StartingPrice.ToString("N0")</span>

                            </div>

                            <div class="card-status">Status: @property.Status</div>

                        </div>

                    </div>

                }

            }

        </div>

    </div>

</div>

@if (showCreateModal)

{

    <div class="modal-overlay" @onclick="HideCreatePropertyModal">

        <div class="modal-content" @onclick:stopPropagation="true">

            <div class="modal-header">

                <h2 class="modal-title">Create New Property</h2>

                <button class="modal-close-button" @onclick="HideCreatePropertyModal" type="button">

                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">

                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>

                    </svg>

                </button>

            </div>

            <div class="modal-body">

                <EditForm Model="@createPropertyDto" OnValidSubmit="HandleCreateProperty">

                    <DataAnnotationsValidator />

                    <div class="form-group">

                        <label class="form-label" for="title">Title <span class="required">*</span></label>

                        <InputText id="title" class="form-input" @bind-Value="createPropertyDto.Title" placeholder="Enter property title" />

                        <ValidationMessage For="@(() => createPropertyDto.Title)" />

                    </div>

                    <div class="form-group">

                        <label class="form-label" for="address">Address <span class="required">*</span></label>

                        <InputText id="address" class="form-input" @bind-Value="createPropertyDto.Address" placeholder="Enter property address" />

                        <ValidationMessage For="@(() => createPropertyDto.Address)" />

                    </div>

                    <div class="form-row">

                        <div class="form-group">

                            <label class="form-label" for="startingPrice">Starting Price <span class="required">*</span></label>

                            <InputNumber id="startingPrice" class="form-input" @bind-Value="createPropertyDto.StartingPrice" placeholder="0.00" />

                            <ValidationMessage For="@(() => createPropertyDto.StartingPrice)" />

                        </div>

                        <div class="form-group">

                            <label class="form-label" for="sizeInSquareFeet">Size (sq ft) <span class="required">*</span></label>

                            <InputNumber id="sizeInSquareFeet" class="form-input" @bind-Value="createPropertyDto.SizeInSquareFeet" placeholder="0" />

                            <ValidationMessage For="@(() => createPropertyDto.SizeInSquareFeet)" />

                        </div>

                    </div>

                    <div class="form-row">

                        <div class="form-group">

                            <label class="form-label" for="bedrooms">Bedrooms <span class="required">*</span></label>

                            <InputNumber id="bedrooms" class="form-input" @bind-Value="createPropertyDto.Bedrooms" placeholder="0" />

                            <ValidationMessage For="@(() => createPropertyDto.Bedrooms)" />

                        </div>

                        <div class="form-group">

                            <label class="form-label" for="bathrooms">Bathrooms <span class="required">*</span></label>

                            <InputNumber id="bathrooms" class="form-input" @bind-Value="createPropertyDto.Bathrooms" placeholder="0" />

                            <ValidationMessage For="@(() => createPropertyDto.Bathrooms)" />

                        </div>

                    </div>

                    <div class="form-group">

                        <label class="form-label" for="description">Description</label>

                        <textarea id="description" class="form-input form-textarea" @bind="createPropertyDto.Description" placeholder="Enter property description (optional)" rows="4"></textarea>

                        <ValidationMessage For="@(() => createPropertyDto.Description)" />

                    </div>

                    @if (!string.IsNullOrEmpty(createPropertyError))

                    {

                        <div class="form-error">@createPropertyError</div>

                    }

                    <div class="modal-footer">

                        <button type="button" class="form-button form-button-cancel" @onclick="HideCreatePropertyModal">Cancel</button>

                        <button type="submit" class="form-button form-button-submit" disabled="@isCreatingProperty">@(isCreatingProperty ? "Creating..." : "Create Property")</button>

                    </div>

                </EditForm>

            </div>

        </div>

    </div>

}

@code {

    private List<PropertyDto>? properties;

    private bool isLoading = false;

    private int? currentAgentId = null;

    private bool showCreateModal = false;

    private bool isCreatingProperty = false;

    private string createPropertyError = string.Empty;

    private CreatePropertyDto createPropertyDto = new CreatePropertyDto { Title = string.Empty };

    protected override async Task OnInitializedAsync()

    {

        await LoadAgentId();

        await LoadProperties();

    }

    private async Task LoadAgentId()

    {

        try

        {

            var authState = await AuthProvider.GetAuthenticationStateAsync();

            if (authState.User.Identity?.IsAuthenticated == true)

            {

                var userIdClaim = authState.User.FindFirst("Id")?.Value;

                if (int.TryParse(userIdClaim, out int agentId))

                {

                    currentAgentId = agentId;

                }

            }

        }

        catch

        {

            // Handle error silently

        }

    }

    private async Task LoadProperties()

    {

        isLoading = true;

        try

        {

            if (currentAgentId.HasValue)

            {

                properties = await PropertyService.GetByAgentAsync(currentAgentId.Value);

            }

            else

            {

                properties = new List<PropertyDto>();

            }

        }

        catch (Exception ex)

        {

            properties = new List<PropertyDto>();

        }

        finally

        {

            isLoading = false;

        }

    }

    private void NavigateToProperty(int propertyId)

    {

        Navigation.NavigateTo($"/property/{propertyId}");

    }

    private async Task ShowCreatePropertyModal()

    {

        if (currentAgentId.HasValue)

        {

            createPropertyDto = new CreatePropertyDto

            {

                AgentId = currentAgentId.Value,

                Title = string.Empty,

                Address = string.Empty,

                StartingPrice = 0,

                Bedrooms = 0,

                Bathrooms = 0,

                SizeInSquareFeet = 0,

                Description = string.Empty

            };

            createPropertyError = string.Empty;

            showCreateModal = true;

        }

        else

        {

            createPropertyError = "Unable to get agent ID. Please log in again.";

        }

    }

    private void HideCreatePropertyModal()

    {

        showCreateModal = false;

        createPropertyError = string.Empty;

        createPropertyDto = new CreatePropertyDto { Title = string.Empty };

    }

    private async Task HandleCreateProperty()

    {

        isCreatingProperty = true;

        createPropertyError = string.Empty;

        try

        {

            await PropertyService.CreateAsync(createPropertyDto);

            HideCreatePropertyModal();

            await LoadProperties();

        }

        catch (Exception ex)

        {

            createPropertyError = $"An error occurred: {ex.Message}";

        }

        finally

        {

            isCreatingProperty = false;

        }

    }

}

