@page "/signup"
@namespace BlazorApp.Components.Pages
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using shared.DTOs.Users

@inject NavigationManager Navigation
@inject HttpUserService UserService

<PageTitle>Sign Up - Bidinly</PageTitle>

<div class="login-page">
    <div class="login-container">
        <div class="login-header">
            <h1>Sign Up</h1>
            <p>Create your credentials to get started</p>
        </div>

        <EditForm Model="@signUpModel" OnValidSubmit="HandleSignUp" class="login-form-container">
            <DataAnnotationsValidator />
            <ValidationSummary />

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="login-error">@errorMessage</div>
            }

            <div class="login-form-group">
                <label for="username">Username</label>
                <InputText id="username"
                           class="login-form-input"
                           placeholder="Enter your username"
                           @bind-Value="signUpModel.Username" />
            </div>

            <div class="login-form-group">
                <label for="password">Password</label>
                <InputText id="password"
                           type="password"
                           class="login-form-input"
                           placeholder="Enter your password"
                           @bind-Value="signUpModel.Password" />
            </div>

            <div class="login-form-group">
                <label for="email">Email</label>
                <InputText id="email"
                           type="email"
                           class="login-form-input"
                           placeholder="Enter your email (optional)"
                           @bind-Value="signUpModel.Email" />
            </div>

            <div class="login-form-group role-toggle">
                <label>Account type</label>
                <div class="role-options">
                    <button type="button"
                            class="@GetRoleButtonClass(1)"
                            @onclick="@(() => SetRole(1))">
                        <span class="role-circle"></span>
                        <span>Agent</span>
                    </button>
                    <button type="button"
                            class="@GetRoleButtonClass(2)"
                            @onclick="@(() => SetRole(2))">
                        <span class="role-circle"></span>
                        <span>Buyer</span>
                    </button>
                </div>
            </div>

            <div class="login-form-actions">
                <button type="button" class="login-button-cancel" @onclick="HandleCancel">
                    Cancel
                </button>
                <button type="submit" class="login-button-confirm" disabled="@isSubmitting">
                    @(isSubmitting ? "Submitting..." : "Create Account")
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private readonly SignUpModel signUpModel = new();
    private bool isSubmitting;
    private string? errorMessage;

    private async Task HandleSignUp()
    {
        isSubmitting = true;
        errorMessage = null;
        try
        {
            var dto = new CreateUserDto
            {
                Username = signUpModel.Username,
                Password = signUpModel.Password,
                RoleId = signUpModel.RoleId,
                Email = string.IsNullOrWhiteSpace(signUpModel.Email) ? null : signUpModel.Email
            };

            await UserService.CreateAsync(dto);
            Navigation.NavigateTo("/login");
            return;
        }
        catch (Exception ex)
        {
            errorMessage = $"Unable to create account: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void SetRole(int roleId)
    {
        signUpModel.RoleId = roleId;
    }

    private string GetRoleButtonClass(int roleId) =>
        $"role-option{(signUpModel.RoleId == roleId ? " active" : string.Empty)}";

    private void HandleCancel()
    {
        Navigation.NavigateTo("/", forceLoad: false);
    }

    private sealed class SignUpModel
    {
        [Required]
        [StringLength(50, MinimumLength = 3)]
        public string Username { get; set; } = string.Empty;

        [Required]
        [StringLength(100, MinimumLength = 3)]
        public string Password { get; set; } = string.Empty;

        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string? Email { get; set; }

        [Required]
        public int RoleId { get; set; } = 2;
    }

}

