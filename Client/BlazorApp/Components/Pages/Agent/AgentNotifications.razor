@page "/agent-notifications"
@layout NoLayout
@using Shared.DTOs.Properties
@inject HttpClient Http
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

@using Shared.DTOs.Notifications

<PageTitle>Notifications - Bidinly</PageTitle>

<div class="notifications-page">

<div class="back-button-wrapper">
    <button class="back-button" @onclick="GoBack">
        ‚Üê Back
    </button>
</div>

<div class="notifications-content">
    <div class="page-header">
        <h1 class="page-title">Notifications</h1>
    </div>

    <div class="notifications-section">

        @if (isLoading)
        {
            <div class="loading">Loading notifications...</div>
        }
        else if (!notifications.Any())
        {
            <div class="no-results">No notifications yet.</div>
        }
        else
        {
            <div class="notifications-container">
                @foreach (var n in notifications)
                {
                    var (title, type) = n.Status switch
                    {
                        "SaleCompleted" => ("Property Sold", "success"),
                        _ => ("Notification", "info")
                    };

                    <div class="notification-card @GetTypeClass(type)">
                        <div class="notification-header">
                            <h3 class="notification-title">@title</h3>

                            <div class="notif-header-right">
                                <span class="notification-date">
                                    @n.CreatedAt.ToString("g")
                                </span>

                                <button class="notif-read-icon"
                                        title="Mark as read"
                                        @onclick="() => MarkAsRead(n.Id)">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>

                        <div class="notification-message">

                            <div class="notif-message-top">
                                <button class="notif-action-button"
                                        @onclick="() => GoToProperty(n.PropertyId)">
                                    @propertyTitles.GetValueOrDefault(n.PropertyId, "Property")
                                </button>
                            </div>

                            <div class="notif-message-text">
                                @n.Message
                            </div>

                        </div>
                    </div>
                }
            </div>
        }

    </div>
</div>
</div>

@code {
    private List<NotificationDto> notifications = new();
    private bool isLoading = true;
    private Dictionary<int, string> propertyTitles = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var agentId = int.Parse(authState.User.FindFirst("Id")!.Value);
        
        notifications = await Http.GetFromJsonAsync<List<NotificationDto>>(
            $"/notifications?userId={agentId}&isRead=false"
        ) ?? new();
        
        foreach (var n in notifications)
        {
            if (!propertyTitles.ContainsKey(n.PropertyId))
            {
                var property = await Http.GetFromJsonAsync<PropertyDto>(
                    $"/properties/{n.PropertyId}"
                );

                if (property != null)
                {
                    propertyTitles[n.PropertyId] = property.Title;
                }
            }
        }

        isLoading = false;
    }

    private void GoBack() =>
        Navigation.NavigateTo("/agent-dashboard");

    private string GetTypeClass(string type) =>
        type switch
        {
            "success" => "notif-success",
            "error" => "notif-error",
            "warning" => "notif-warning",
            _ => "notif-info"
        };
    
    private void GoToProperty(int propertyId) =>
        Navigation.NavigateTo($"/agent/property/{propertyId}");


    private async Task MarkAsRead(int notificationId) 
    { 
        await Http.PutAsync($"/notifications/{notificationId}/read", null);
        notifications.RemoveAll(n => n.Id == notificationId);
        
    }
}