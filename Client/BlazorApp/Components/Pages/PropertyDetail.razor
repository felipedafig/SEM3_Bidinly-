@page "/property/{id:int}"
@layout NoNavLayout
@using shared.DTOs.Properties
@using Shared.DTOs.Bids
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Property Details - @property?.Title</PageTitle>

@if (isLoading)
{
    <div class="loading">
        <p>Loading property details...</p>
    </div>
}
else if (property != null)
{
    <div class="property-detail-page">
        <div class="property-images">
            <div class="main-image-placeholder">
                <span>Main Image</span>
            </div>
            <div class="thumbnail-images">
                <div class="thumbnail-placeholder"><span>Image 1</span></div>
                <div class="thumbnail-placeholder"><span>Image 2</span></div>
                <div class="thumbnail-placeholder"><span>Image 3</span></div>
                <div class="thumbnail-placeholder"><span>Image 4</span></div>
            </div>
        </div>

        <div class="property-content">
            <div class="property-details">
                <h1 class="detail-title">@property.Title</h1>
                
                @if (!string.IsNullOrWhiteSpace(property.Address))
                {
                    <p class="detail-address">üìç @property.Address</p>
                }
                
                @if (!string.IsNullOrWhiteSpace(property.Description))
                {
                    <p class="detail-description">@property.Description</p>
                }
                
                <div class="detail-info-grid">
                    <div class="info-item">
                        <span class="info-label">Starting Price:</span>
                        <span class="info-value">$@property.StartingPrice.ToString("N0")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Bedrooms:</span>
                        <span class="info-value">@property.Bedrooms</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Bathrooms:</span>
                        <span class="info-value">@property.Bathrooms</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Size:</span>
                        <span class="info-value">@property.SizeInSquareFeet.ToString("N0") sq ft</span>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(property.Status))
                    {
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="info-value">@property.Status</span>
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(property.AgentName))
                    {
                        <div class="info-item">
                            <span class="info-label">Agent:</span>
                            <span class="info-value">@property.AgentName</span>
                        </div>
                    }
                </div>
            </div>

            <div class="bid-section">
                <h2 class="bid-title">Place Your Bid</h2>
                <EditForm Model="@bidForm" OnValidSubmit="SubmitBid">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label for="amount">Amount *</label>
                        <InputNumber id="amount" class="form-control" @bind-Value="bidForm.Amount" />
                        <ValidationMessage For="@(() => bidForm.Amount)" />
                    </div>

                    <div class="form-group">
                        <label for="expiryDate">Expiry Date *</label>
                        <InputDate id="expiryDate" class="form-control" @bind-Value="expiryDate" />
                        <ValidationMessage For="@(() => bidForm.ExpiryDate)" />
                    </div>

                    <button type="submit" class="btn-bid" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>Submitting...</span>
                        }
                        else
                        {
                            <span>Bid</span>
                        }
                    </button>
                </EditForm>
            </div>
        </div>
    </div>
}
else
{
    <div class="no-results">
        <p>Property not found</p>
        <button class="btn-back" @onclick="GoBack">Go Back</button>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    
    private PropertyDto? property;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private CreateBidDto bidForm = new();
    private DateTime? expiryDate;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadProperty();
        bidForm.PropertyId = Id;
        bidForm.BuyerId = 1; // TODO: Get from authenticated user
    }
    
    private async Task LoadProperty()
    {
        try
        {
            isLoading = true;
            property = await Http.GetFromJsonAsync<PropertyDto>($"properties/{Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading property: {ex.Message}");
            property = null;
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task SubmitBid(EditContext editContext)
    {
        if (!expiryDate.HasValue)
        {
            // TODO: Show validation error
            return;
        }
        
        bidForm.ExpiryDate = expiryDate.Value;
        
        try
        {
            isSubmitting = true;
            var response = await Http.PostAsJsonAsync("bids", bidForm);
            
            if (response.IsSuccessStatusCode)
            {
                // TODO: Show success message
                Navigation.NavigateTo("/");
            }
            else
            {
                // TODO: Show error message
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error submitting bid: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error submitting bid: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
    
    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}

