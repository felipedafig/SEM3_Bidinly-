@page "/dashboard"
@page "/buyer-dashboard"
@layout Layout.MainLayoutAuthenticated
@namespace BlazorApp.Components.Pages
@using shared.DTOs.Properties
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Authorization

@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Dashboard - Bidinly</PageTitle>

<div class="home-background">
    <img src="/assets/images/Home-Background.png" alt="Modern Property" />
    
    <div class="hero-content">
        <h1 class="hero-title">Bid to win your Dream Property...</h1>
        <div class="hero-search-container">
            <input type="text" class="hero-search-bar" placeholder="Find a property..." @bind="searchQuery" @onkeydown="HandleSearchKeyDown" />
            <button class="hero-search-button" @onclick="PerformSearch" type="button">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<div class="filter-search-section">
    <div class="filter-search-container">
        <div class="filter-field">
            <label class="filter-label">City</label>
            <input type="text" class="filter-input" placeholder="city?" @bind="filterCity" />
        </div>
        <div class="filter-separator"></div>
        <div class="filter-field">
            <label class="filter-label">Bedrooms</label>
            <input type="number" class="filter-input" placeholder="bedrooms?" min="0" @bind="filterBedrooms" />
        </div>
        <div class="filter-separator"></div>
        <div class="filter-field">
            <label class="filter-label">Bathrooms</label>
            <input type="number" class="filter-input" placeholder="bathrooms?" min="0" @bind="filterBathrooms" />
        </div>
        <div class="filter-separator"></div>
        <div class="filter-field">
            <label class="filter-label">Min Price</label>
            <input type="number" class="filter-input" placeholder="min price?" min="0" @bind="filterMinPrice" />
        </div>
        <div class="filter-separator"></div>
        <div class="filter-field">
            <label class="filter-label">Max Price</label>
            <input type="number" class="filter-input" placeholder="max price?" min="0" @bind="filterMaxPrice" />
        </div>
        <button class="filter-search-button" @onclick="LoadProperties" type="button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
</div>

<div class="properties-section">
    <div class="properties-container">
        @if (isLoading)
        {
            <div class="loading">Loading properties...</div>
        }
        else if (properties == null || !properties.Any())
        {
            <div class="no-results">No properties found.</div>
        }
        else
        {
            @foreach (var property in properties)
            {
                <div class="property-card" @onclick="() => NavigateToProperty(property.Id)">
                    <div class="card-image-placeholder">
                        <span>Image</span>
                    </div>
                    <div class="card-details">
                        <h3 class="card-title">@property.Title</h3>
                        <p class="card-address">@property.Address</p>
                        <p class="card-description">@property.Description</p>
                        <div class="card-info">
                            <span class="info-item">Bedrooms: @property.Bedrooms</span>
                            <span class="info-item">Bathrooms: @property.Bathrooms</span>
                            <span class="info-item">Size: @property.SizeInSquareFeet sq ft</span>
                            <span class="info-item">Price: $@property.StartingPrice.ToString("N0")</span>
                        </div>
                        <div class="card-status">Status: @property.Status</div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<PropertyDto>? properties;
    private bool isLoading = false;
    private string searchQuery = string.Empty;
    private string filterCity = string.Empty;
    private int? filterBedrooms;
    private int? filterBathrooms;
    private double? filterMinPrice;
    private double? filterMaxPrice;

    protected override async Task OnInitializedAsync()
    {
        await LoadProperties();
    }

    private async Task LoadProperties()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<List<PropertyDto>>("properties");
            properties = response ?? new List<PropertyDto>();
        }
        catch (Exception ex)
        {
            properties = new List<PropertyDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToProperty(int propertyId)
    {
        Navigation.NavigateTo($"/property/{propertyId}");
    }

    private async Task PerformSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            Navigation.NavigateTo($"/?search={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
    }
}
