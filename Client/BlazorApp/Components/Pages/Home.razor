@page "/"
@using shared.DTOs.Properties
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Bidinly</PageTitle>

<div class="home-background">
    <img src="/assets/images/Home-Background.png" alt="Modern Property" />
    
    <div class="hero-content">
        <h1 class="hero-title">Bid to win your Dream Property...</h1>
        <div class="hero-search-container">
            <input type="text" class="hero-search-bar" placeholder="Find a property..." />
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
    </div>
    
    <div class="project-info-section">
        <div class="project-info-container">
            <h2 class="project-title">
                <span class="title-line-1">Semester Project</span>
                <span class="title-line-2">Third Semester - VIA College</span>
            </h2>
            <p class="project-description">
                The application is a real estate bidding platform built as a 3-tier distributed system. Essential for familiarizing with modern web development practices and technologies (Blazor, APIs, Grpc, Spring Boot, etc).
            </p>
            <a href="https://github.com/felipedafig/SEM3_Bidinly-" target="_blank" rel="noopener noreferrer" class="git-repo-button">
                Git Repo
            </a>
        </div>
    </div>
</div>

<div class="filter-search-section">
    <div class="filter-search-container">
        <div class="filter-field">
            <label class="filter-label">City</label>
            <input type="text" class="filter-input" placeholder="where?" @bind="filterCity" />
        </div>
        <div class="filter-separator"></div>
        <div class="filter-field">
            <label class="filter-label">Bedrooms</label>
            <input type="number" class="filter-input" placeholder="how many?" min="0" value="@filterBedrooms" @oninput="OnBedroomsInput" />
        </div>
        <div class="filter-separator"></div>
        <div class="filter-field">
            <label class="filter-label">Bathrooms</label>
            <input type="number" class="filter-input" placeholder="how many?" min="0" value="@filterBathrooms" @oninput="OnBathroomsInput" />
        </div>
        <div class="filter-separator"></div>
        <div class="filter-field">
            <label class="filter-label">Min. square meters</label>
            <input type="number" class="filter-input" placeholder="how big?" min="0" value="@filterMinSquareMeters" @oninput="OnMinSquareMetersInput" />
        </div>
        <button class="filter-search-button" @onclick="ApplyFilters">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
</div>

@code {
    private string searchQuery = string.Empty;
    private string filterCity = string.Empty;
    private int? filterBedrooms;
    private int? filterBathrooms;
    private int? filterMinSquareMeters;
    private List<PropertyDto> properties = new();
    
    protected override async Task OnInitializedAsync()
    {
        await LoadProperties();
    }
    
    private async Task LoadProperties()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<PropertyDto>>("properties");
            properties = response ?? new List<PropertyDto>();
        }
        catch (Exception ex)
        {
            // Handle error - in production, you'd want proper error handling
            Console.WriteLine($"Error loading properties: {ex.Message}");
            properties = new List<PropertyDto>();
        }
    }
    
    private IEnumerable<PropertyDto> filteredProperties => 
        string.IsNullOrWhiteSpace(searchQuery) 
            ? properties 
            : properties.Where(p => p.Title != null && p.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
    
    private void ApplyFilters()
    {
        // Filter logic will be implemented here
        // For now, this is a placeholder
    }
    
    private void OnBedroomsInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            filterBedrooms = null;
        }
        else if (int.TryParse(value, out int intValue) && intValue >= 0)
        {
            filterBedrooms = intValue;
        }
        else
        {
            filterBedrooms = null;
        }
    }
    
    private void OnBathroomsInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            filterBathrooms = null;
        }
        else if (int.TryParse(value, out int intValue) && intValue >= 0)
        {
            filterBathrooms = intValue;
        }
        else
        {
            filterBathrooms = null;
        }
    }
    
    private void OnMinSquareMetersInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            filterMinSquareMeters = null;
        }
        else if (int.TryParse(value, out int intValue) && intValue >= 0)
        {
            filterMinSquareMeters = intValue;
        }
        else
        {
            filterMinSquareMeters = null;
        }
    }
}
